<!DOCTYPE html>
<html>
<head>
  <title>Network Attack Visualization</title>
  <link rel="icon" href="data:,">
  <script src="https://unpkg.com/3d-force-graph"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial; }
    #graph-container { width: 100vw; height: 100vh; }
    #status {
      position: absolute; 
      top: 10px; 
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      max-width: 300px;
    }
    #search-container {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    #legend {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      z-index: 10;
    }
    button {
      background: #444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover { background: #555; }
    input {
      padding: 5px;
      border-radius: 3px;
      border: none;
    }
  </style>
</head>
<body>
  <div id="graph-container"></div>
  <div id="status">Loading...</div>
  <div id="controls">
    <button onclick="toggleVisibility('benign')">Toggle Benign</button>
    <button onclick="toggleVisibility('malicious')">Toggle Malicious</button>
    <button onclick="hardReset()">Reset View</button>
    <button onclick="exportPNG()">Save as PNG</button>
  </div>
  <div id="search-container">
    <input type="text" id="search" placeholder="Search IP...">
    <button onclick="highlightNode()">üîç</button>
  </div>
  <div id="tooltip"></div>
  <div id="legend">
    <div><span style="color:green">‚ñ†</span> Benign Nodes</div>
    <div><span style="color:#ff3333">‚ñ†</span> Malicious (High Confidence ‚â•80%)</div>
    <div><span style="color:#ff6666">‚ñ†</span> Malicious (Medium Confidence 60-79%)</div>
    <div><span style="color:#ff9999">‚ñ†</span> Malicious (Low Confidence <60%)</div>
  </div>

  <script>
    // Global variables
    const statusEl = document.getElementById('status');
    const tooltipEl = document.getElementById('tooltip');
    const container = document.getElementById('graph-container');
    let Graph;
    let originalGraphData;

    // Main initialization function
    async function initializeVisualization() {
      try {
        statusEl.textContent = "Loading graph data...";
        
        // Load data
        const response = await fetch('../data/graph.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (!data.nodes || !data.links) throw new Error("Invalid graph structure");
        
        // Store original data
        originalGraphData = JSON.parse(JSON.stringify(data));
        
        // Initialize graph
        initGraph(data);
      } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
        console.error("Initialization error:", e);
      }
    }

    // Graph initialization
    function initGraph(data) {
      // Clear previous graph if exists
      if (Graph) {
        container.innerHTML = '';
        Graph = null;
      }

      statusEl.textContent = "Rendering...";
      
      // Create new graph instance
      Graph = ForceGraph3D()(container)
        .graphData(data)
        .nodeLabel(node => `${node.id}\nType: ${node.group ? 'MALICIOUS' : 'Benign'}\nConfidence: ${(node.confidence * 100).toFixed(1)}%`)
        .nodeColor(node => {
          if (!node.group) return '#00cc00';
          if (node.confidence >= 0.8) return '#ff3333';
          if (node.confidence >= 0.6) return '#ff6666';
          return '#ff9999';
        })
        .nodeVal(node => node.group ? 2 + (node.confidence * 5) : 2)
        .nodeOpacity(0.9)
        .linkColor(() => 'rgba(255, 255, 255, 0.5)')
        .linkWidth(1)
        .onNodeHover(node => {
          container.style.cursor = node ? 'pointer' : null;
          if (node) {
            showTooltip(node);
            highlightConnections(node);
          } else {
            hideTooltip();
            resetConnections();
          }
        })
        .onNodeClick(zoomToNode)
        .onEngineStop(() => {
          if (!statusEl.textContent.includes('Done!')) {
            const maliciousCount = data.nodes.filter(n => n.group).length;
            statusEl.textContent = `Rendered ${data.nodes.length} nodes (${maliciousCount} malicious), ${data.links.length} links | Done!`;
          }
        });

      // Initial camera position
      Graph.cameraPosition({ z: 500 });

      // Set up event listeners
      setupEventListeners();
    }

    // Helper functions
    function showTooltip(node) {
      tooltipEl.style.display = 'block';
      tooltipEl.innerHTML = `
        <strong>${node.id}</strong><br>
        Type: ${node.group ? 'MALICIOUS' : 'Benign'}<br>
        Confidence: ${(node.confidence * 100).toFixed(1)}%
      `;
    }

    function hideTooltip() {
      tooltipEl.style.display = 'none';
    }

    function highlightConnections(node) {
      Graph.linkColor(link => 
        link.source === node.id || link.target === node.id 
          ? 'rgba(255, 255, 0, 0.8)' 
          : 'rgba(200, 200, 200, 0.2)'
      );
    }

    function resetConnections() {
      Graph.linkColor(() => 'rgba(200, 200, 200, 0.2)');
    }

    function zoomToNode(node) {
      Graph.cameraPosition(
        { x: node.x, y: node.y, z: 150 },
        node,
        1000
      );
    }

    function setupEventListeners() {
      // Mouse movement for tooltip
      container.addEventListener('mousemove', event => {
        if (tooltipEl.style.display === 'block') {
          tooltipEl.style.left = `${event.clientX + 15}px`;
          tooltipEl.style.top = `${event.clientY + 15}px`;
        }
      });

      // Window resize
      window.addEventListener('resize', () => {
        if (Graph) {
          Graph.width(container.offsetWidth);
          Graph.height(container.offsetHeight);
        }
      });
    }

    // Control functions
    function toggleVisibility(type) {
      Graph.nodeVisibility(node => 
        type === 'benign' ? !node.group : node.group
      );
    }

    function highlightNode() {
      const query = document.getElementById('search').value.trim();
      if (!query) return;
      
      Graph.nodeColor(node => 
        node.id.includes(query) 
          ? '#ffff00' 
          : !node.group 
            ? '#00cc00'
            : node.confidence >= 0.8 
              ? '#ff3333'
              : node.confidence >= 0.6 
                ? '#ff6666'
                : '#ff9999'
      );
    }

    function hardReset() {
      // Completely reinitialize the visualization
      initializeVisualization();
      document.getElementById('search').value = '';
    }

    function exportPNG() {
      Graph.screenshot();
    }

    // Start the application
    initializeVisualization();
  </script>
</body>
</html>