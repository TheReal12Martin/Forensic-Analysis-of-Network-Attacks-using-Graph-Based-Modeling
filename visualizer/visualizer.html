<!DOCTYPE html>
<html>
<head>
  <title>Network Attack Visualization</title>
  <link rel="icon" href="data:,"> <!-- Disable favicon requests -->
  <script src="https://unpkg.com/3d-force-graph"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #graph-container { width: 100vw; height: 100vh; }
    #status {
      position: absolute; 
      top: 10px; 
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial;
    }
    #legend {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial;
    }
    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      font-family: Arial;
      font-size: 14px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="graph-container"></div>
  <div id="status">Loading...</div>
  <div id="tooltip"></div>
  <div id="legend">
    <div><span style="color:green">■</span> Benign Nodes</div>
    <div><span style="color:#ff3333">■</span> Malicious (High Confidence ≥80%)</div>
    <div><span style="color:#ff6666">■</span> Malicious (Medium Confidence 60-79%)</div>
    <div><span style="color:#ff9999">■</span> Malicious (Low Confidence <60%)</div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const tooltipEl = document.getElementById('tooltip');
    const container = document.getElementById('graph-container');

    async function loadData() {
      statusEl.textContent = "Loading graph data...";
      
      try {
        const response = await fetch('../data/graph.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (!data.nodes || !data.links) throw new Error("Invalid graph structure");
        
        // Calculate stats
        const maliciousNodes = data.nodes.filter(n => n.group).length;
        statusEl.textContent = `Loaded ${data.nodes.length} nodes (${maliciousNodes} malicious), ${data.links.length} links`;
        return data;
      } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
        throw e;
      }
    }

    function initGraph(data) {
      statusEl.textContent = "Rendering...";
      
      const Graph = ForceGraph3D()(container)
        .graphData(data)
        .nodeLabel(node => {
          const type = node.group ? 'MALICIOUS' : 'Benign';
          const conf = (node.confidence * 100).toFixed(1);
          return `${node.id}\nType: ${type}\nConfidence: ${conf}%`;
        })
        .nodeColor(node => {
          // Benign nodes - solid green
          if (!node.group) return '#00cc00';
          
          // Malicious nodes - red shades based on confidence
          if (node.confidence >= 0.8) return '#ff3333'; // Dark red
          if (node.confidence >= 0.6) return '#ff6666'; // Medium red
          return '#ff9999'; // Light red
        })
        .nodeOpacity(0.9)
        .linkColor(() => 'rgba(200, 200, 200, 0.2)')
        .onNodeHover(node => {
          container.style.cursor = node ? 'pointer' : null;
          
          if (node) {
            tooltipEl.style.display = 'block';
            tooltipEl.style.left = `${Graph.screen2GraphCoords(event).x}px`;
            tooltipEl.style.top = `${Graph.screen2GraphCoords(event).y}px`;
            tooltipEl.innerHTML = `
              <strong>${node.id}</strong><br>
              Type: ${node.group ? 'MALICIOUS' : 'Benign'}<br>
              Confidence: ${(node.confidence * 100).toFixed(1)}%
            `;
          } else {
            tooltipEl.style.display = 'none';
          }
        })
        .onEngineStop(() => {
          statusEl.textContent += " | Done!";
        });
      
      // Adjust camera
      Graph.cameraPosition({ z: 500 });
      
      // Track mouse movement for tooltip
      container.addEventListener('mousemove', event => {
        if (tooltipEl.style.display === 'block') {
          tooltipEl.style.left = `${event.clientX + 15}px`;
          tooltipEl.style.top = `${event.clientY + 15}px`;
        }
      });
    }

    // Start everything
    loadData()
      .then(initGraph)
      .catch(e => console.error("Fatal error:", e));
  </script>
</body>
</html>